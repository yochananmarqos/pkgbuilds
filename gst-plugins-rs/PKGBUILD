# https://aur.archlinux.org/packages/gst-plugins-rs
groups=('modified')

## WIP

#Dependency dav1d found: NO found 1.4.0 but need: '<1.3' ; matched: '>=1.0'
#Did not find CMake 'cmake'
#Found CMake: NO
#Run-time dependency dav1d found: NO 

#gst-plugins-rs/meson.build:380:14: ERROR: Dependency lookup for dav1d with method 'pkgconfig' failed: Invalid version, need 'dav1d' ['<1.3'] found '1.4.0'.


pkgname=gst-plugins-rs
pkgver=1.24.0
pkgrel=1
pkgdesc="GStreamer plugins written in Rust"
arch=('x86_64')
url="https://gitlab.freedesktop.org/gstreamer/gst-plugins-rs"
license=('Apache-2.0 AND LGPL-2.1-or-later AND MIT AND MPL-2.0')
depends=(
  'cairo'
  'dav1d'
  'gst-plugins-base-libs'
  'gst-plugins-bad-libs'
  'graphene'
  'gstreamer'
  'gtk4'
  'libwebp'
  'libsodium'
  'openssl'
  'pango'
)
makedepends=(
  'cargo'
  'cargo-c'
  'clang'
  'git'
  'hotdoc'
  'meson'
  'nasm'
  'python-tomli'
)
provides=('gst-plugin-gtk4')
conflicts=('gst-plugin-gtk4')
options=('!lto')
_commit=55b74c9a9af3539ea9cf8acdcd98deaf839898c3  # tags/gstreamer-1.24.0^0
source=("git+https://gitlab.freedesktop.org/gstreamer/gst-plugins-rs.git#commit=${_commit}")
sha256sums=('SKIP')

pkgver() {
  cd "${pkgname}"
  git describe --tags | sed 's/^gstreamer-//;s/-/+/g'
}

prepare() {
  cd "${pkgname}"
  export CARGO_HOME="${srcdir}/cargo-home"
  export RUSTUP_TOOLCHAIN=stable
  cargo fetch --target x86_64-unknown-linux-gnu
}

build() {
  export CARGO_HOME="${srcdir}/cargo-home"
  export RUSTUP_TOOLCHAIN=stable
  arch-meson "${pkgname}" build \
    -D sodium-source='system'
  meson compile -C build
}

check() {
  export CARGO_HOME="${srcdir}/cargo-home"
  export RUSTUP_TOOLCHAIN=stable
  meson test -C build --print-errorlogs || :
}

package() {
  meson install -C build --destdir "${pkgdir}"

  cd "${pkgname}"
  install -Dm644 LICENSE-MIT -t "${pkgdir}/usr/share/licenses/${pkgname}/"
}
