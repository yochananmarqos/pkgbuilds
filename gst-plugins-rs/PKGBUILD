# https://aur.archlinux.org/packages/gst-plugins-rs
groups=('modified')

#  --- stderr
#  Package dependency requirement 'dav1d <= 1.2.1' could not be satisfied.
#  Package 'dav1d' has version '1.3.0', required version is '<= 1.2.1'

pkgname=gst-plugins-rs
pkgver=1.22.8
pkgrel=1
pkgdesc="GStreamer plugins written in Rust"
arch=('x86_64')
url="https://gitlab.freedesktop.org/gstreamer/gst-plugins-rs"
license=('Apache' 'LGPL2.1' 'MIT' 'MPL2')
depends=('cairo' 'dav1d' 'gst-plugins-base-libs' 'gst-plugins-bad-libs' 'graphene'
         'gstreamer' 'gtk4' 'libwebp' 'libsodium' 'openssl' 'pango')
makedepends=('cargo' 'cargo-c' 'clang' 'git' 'hotdoc' 'meson' 'nasm' 'python-tomli')
provides=('gst-plugin-gtk4')
conflicts=('gst-plugin-gtk4')
options=('!lto')
_commit=c03e1084870c8caca62772fce04ad78aa99521c2  # tags/gstreamer-1.22.8^0
source=("git+https://gitlab.freedesktop.org/gstreamer/gst-plugins-rs.git#commit=${_commit}")
sha256sums=('SKIP')

pkgver() {
  cd "${pkgname}"
  git describe --tags | sed 's/^gstreamer-//;s/-/+/g'
}

prepare() {
  cd "${pkgname}"
  export CARGO_HOME="${srcdir}/cargo-home"
  export RUSTUP_TOOLCHAIN=stable
  cargo fetch --target x86_64-unknown-linux-gnu
}

build() {
  export CARGO_HOME="${srcdir}/cargo-home"
  export RUSTUP_TOOLCHAIN=stable
  arch-meson "${pkgname}" build \
    -D sodium-source='system'
  meson compile -C build
}

check() {
  export CARGO_HOME="${srcdir}/cargo-home"
  export RUSTUP_TOOLCHAIN=stable
  meson test -C build --print-errorlogs || :
}

package() {
  meson install -C build --destdir "${pkgdir}"

  cd "${pkgname}"
  install -Dm644 LICENSE-MIT -t "${pkgdir}/usr/share/licenses/${pkgname}/"
}
