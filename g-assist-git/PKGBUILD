pkgname=g-assist-git
pkgver=1.0.0.rc.2.r152.g6264bc0
pkgrel=1
pkgdesc="A cross-platform unofficial Google Assistant Client for Desktop (powered by Google Assistant SDK)"
arch=('x86_64')
url="https://github.com/Melvin-Abraham/Google-Assistant-Unofficial-Desktop-Client"
license=('Apache')
depends=('gtk3' 'libxss' 'nss')
#depends=('electron10')
makedepends=('git' 'nvm')
provides=("${pkgname%-git}")
conflicts=("${pkgname%-git}")
source=("${pkgname%-git}::git+https://github.com/Melvin-Abraham/Google-Assistant-Unofficial-Desktop-Client.git"
        "${pkgname%-git}.desktop"
#        "${pkgname%-git}.sh"
        )
sha256sums=('SKIP'
            'd8a88933572a7fedb1119ed73ba4ca02db8da5d9ba4d47241dbcdf9fc06eb1ee')

_ensure_local_nvm() {
  # let's be sure we are starting clean
  which nvm >/dev/null 2>&1 && nvm deactivate && nvm unload
  export NVM_DIR="$srcdir/.nvm"

  # The init script returns 3 if version specified
  # in ./.nvrc is not (yet) installed in $NVM_DIR
  # but nvm itself still gets loaded ok
  source /usr/share/nvm/init-nvm.sh || [[ $? != 1 ]]
}

pkgver() {
  cd "$srcdir/${pkgname%-git}"
  git describe --long --tags | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare() {
  cd "$srcdir/${pkgname%-git}"
  export npm_config_cache="$srcdir/npm_cache"
  _ensure_local_nvm
  nvm install 14.18.0
}

build() {
  cd "$srcdir/${pkgname%-git}"
  _ensure_local_nvm
  npm install --cache "$srcdir/npm-cache"
  npm run pack
}

package() {
  cd "$srcdir/${pkgname%-git}"
  install -d "$pkgdir/opt/${pkgname%-git}"
  cp -r dist/linux-unpacked/* "$pkgdir/opt/${pkgname%-git}"
#  install -d "$pkgdir/usr/lib/${pkgname%-git}"
#  cp -r dist/linux-unpacked/resources "$pkgdir/usr/lib/${pkgname%-git}"

#  install -d "$pkgdir/usr/bin"
#  ln -s "/opt/${pkgname%-git}/${pkgname%-git}" "$pkgdir/usr/bin/${pkgname%-git}"

  install -Dm644 app/res/Assistant Logo.png -t "$pkgdir/usr/share/pixmaps/${pkgname%-git}.png"
  install -Dm644 app/res/Assistant Logo.svg -t \
    "$pkgdir/usr/share/icons/hicolor/scalable/apps/${pkgname%-git}.svg"
  install -Dm644 "$srcdir/${pkgname%-git}.desktop" -t "$pkgdir/usr/share/applications"
#  install -Dm755 "$srcdir/${pkgname%-git}.sh" "$pkgdir/usr/bin/${pkgname%-git}"
}
